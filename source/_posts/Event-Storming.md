---
title: Event-Storming
date: 2018-05-31 09:54:23
tags:
- Event Storming
- DDD
- 业务全景图
- 建模工具
---

　　最近在公司内部组织了几场 Event Storming 的 workshop，感觉自己算是可以总结一下，以便更多同学可以了解并且组织这样的活动。

## 业务背景

　　假设我们是一家 B2C 的电商平台，姑且就叫做 “京西” 商城，创业一年多，创业初期一切都是野蛮生长，系统也是 “大泥球（单体应用）” 。公司发展很好，又融资 2000万美金，公司业务需要迅速扩张，而现有系统难以支撑公司业务的快速发展，需要进行微服务的拆分，同时开发团队的规模也要从过去的 20 人增加到 100 人。

　　新加入的同学需要快速了解现有业务，而产品经理也无法对所有业务进行完整描述，过去的开发人员只了解局部业务。过去的业务无论是 “用户故事” 还是厚厚一沓需求文档，都难以让新老同学有一个**快速的**、**统一的**完整认知。

### [Event Storming](http://eventstorming.com/)

　　针对以上的种种困难，我们可以采用 [Event Storming](http://eventstorming.com/) 轻量级建模工具，来帮助我们较短的时间内快速理解业务的全景，达到统一的认知。

　　Event Storming 是完全按照 DDD 的思想所派生出来的工具，所有当我们使用 Event Storming 去探索业务全景的同时，也产出了对业务系统的建模设计。

#### 原则：通用语言

　　在过程中我们唯一需要遵守的重要原则是**通用语言** *（并不是其他原则不重要，而是我没记住，哈哈）*。通用语言在 DDD 中也是重要原则之一。有两层含义：

* 在我们描述业务系统时一定要使用业务场景中的方言，例如，在一件商品被卖空之后，我们电商业务会说**”售罄“**，在餐饮业务中会说**”估清“**。再比如：在很多系统中都会看到如下词汇”用户“、”客户“、”顾客“，这些词汇意思过于相近且难以区分，而在电商业务中更有表现力的词汇是**”买家“**、**”卖家“**。一方面强调所有人统一语言，另一方面减少大家的沟通成本。
* 刚刚说的是纯粹在语言上的通用，而另一层含义是在系统中。你有没有发程序员只是计算机的翻译，我们将业务逻辑翻译成计算机能够理解的语言，而产品经理却是将业务语言翻译成程序员能够理解的逻辑。中间有大量的语言转换，导致我们的系统与真实的业务相差甚远，这其实是不应该出现的一种结果。正确的结果是我们的系统结构与真实世界是一一对应。这一点在以后的 DDD 的文章中再详细阐述。

### 准备工作

　　寻找一个风和日丽的下午，一个大会议室，还要有一个巨大的白板、各种颜色的便签贴。

![带有时间轴的白板](Event-Storming/1.png)

邀请上我们所有需要了解业务的同学：

* **领域专家（业务专家）**
* 产品经理
* 架构师
* DEV
* QA
* ...

　　我们可以邀请所有的相关人员，必不可少的是我们的**领域专家**，在没有领域专家的指导下我们很容易会按照自己的理解而走偏。

### 如何开始？

　　首先，由领域专家将业务背景进行一个大致的介绍，不需要很全面，让大家有一个基本的认识即可。

　　然后由领域专家带来大家找到系统中认为最重要的**领域事件**，贴在我们的带有时间轴的白板上。

#### 什么是领域事件（Domain Event）？

　　在系统中真实发生，需要被记录的事件*（大数据的同学，请不要说话！）*，且会对系统做出**反应**。需要被记录的事件也就意味着需要被追溯。举个例子：电商系统中产生了一笔交易，同时对买家的积分进行了增加。增加积分的事件则需要被记录，而不是单纯的对分数进行修改。当用户希望知道我的积分都去哪了，我们就可以将这些事件进行追溯。

> 大数据的同学会认为所有的事件都应该被记录，为什么不让说话？？？并不是对大数据同学的歧视，大数据并不属于业务系统，而是横切所有系统。



![领域事件](Event-Storming/2.png)

　　用橙色的便利贴表示领域事件，使用 名词 + 动词过去式，例如：订单已创建。通常以XX 已 XXX。

　　在带有时间轴的白板上贴上我们刚刚写好的事件，你认为在事件轴上的任意位置。以这张卡为参照，相继贴上在这张卡之前和之后的事件。

　　此时可以发动大家一起来贴，写好一张就可以贴一张。因为是协同作战，难免会出现重复，为避免重复劳动可以根据事件前后和参与人数进行分组。在贴卡的过程中，领域专家和组织者可以回答大家的业务问题，以及纠正卡片的错误。

　　最后，领域专家要带领大家将贴好的卡片进行梳理，剔除重复的卡片，删除在业务系统中不存在的事件等等。在梳理的过程中会发现很多意想不到的卡片，我们后面再讲。

#### 什么是Policy？

　　Policy 不太好翻译，翻译成政策有一点点奇怪， 是在较新的资料中才有，我们可以理解为规则。

　　在一些业务设计过程中会有很多的规则，这些规则通常不能被建模工具有效的方式表示，都变成了”潜规则“。例如：

*用户输错3次密码之后需要锁定账户。*

**输错3次密码** 就是我们的 Policy，锁定账户则是 Policy 又触发的领域事件。

![Policy](Event-Storming/3.png)

用紫色的便利贴表示 Policy 即可。

#### 什么是命令（Command）？

　　事件贴完了，接下来我们可开始贴**命令**。我们需要探索用户如何与我们的系统进行交互，命令代表着用户与系统的交互，而事件则是发生交互之后所产生的。

![命令](Event-Storming/4.png)



　　用蓝色的卡片表示命令。与 CQRS（Command Query Responsibility Segregation）的Command 含义相同。

*PS: 由于**命令** 与 **领域事件** 大部分是可以一一对应，为节省时间，可以在workshop 中适当省略。*

### 什么是读模型（Read Model）

在写**领域事件**的过程中出现了这样一张卡：

![奇怪的领域事件](Event-Storming/5.png)



　　首先，我们需要先确认这张卡是否真的有这样的业务。买家是否有一个功能是可以看到自己所浏览过的商品列表？通常浏览列表不会被记录，记录的往往是商品详情，可能会有一个【最近浏览的商品】的功能与之对应，那么我们可以这样写：

![商品浏览已收录](Event-Storming/6.png)

　　有同学可能会说，我就是想标记出买家所看到的东西，有什么卡片可以帮助我们吗？这就是——**读模型**。

　　读模型与 Policy 都是较新的资料才出现的。是表示用户所看到的东西，之后用户会发出命令。

![读模型](Event-Storming/7.png)

　　用浅绿色来表示读模型。与 CQRS 的 Query 含义相同。

#### 角色

　　角色是系统中必不可少的，贴到这里我们可以轻易的识别出这一系列卡片由哪个角色触发。

![](Event-Storming/8.png)



　　用黄色表示角色。

### 外部系统（External System）

　　在开发系统时多多少少都会与外部系统做集成，例如：支付系统、短信系统等等。我们通过浅粉色的卡片将外部系统表示出来。

![外部系统](Event-Storming/9.png)

### 业务子域（Sub Domain）

　　啥是业务子域？业务资源通常对应的是一个聚合。啥是聚合？？？这简直不是人话啊！









不仅仅是贴便签，还希望我们在过程中促进沟通。



>根据之前的经验，如果参与的同学对业务完全陌生会导致两个极端：1. 所有人只是在观看领域专家在贴。2. 人们在胡乱贴，而领域专家在不断纠正。虽然出现不同的理解也是我们所希望看到的，但大量的纠正会导致时间上的浪费。





### 词汇解释

* **领域**：在文中提到了大量的”领域“ ，在没有了解过 DDD 的同学肯定晕菜了，我们可以单纯的理解为 ”业务“ ，为什么不直接说 ”业务“ 呢？业务的含义过于广泛，而且一点都不神秘，不够酷！